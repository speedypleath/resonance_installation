<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muse 2 EEG Real-Time Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            min-height: 100vh;
        }
        .header { 
            background: rgba(255,255,255,0.1); 
            padding: 20px; 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .header h1 { 
            text-align: center; 
            font-size: 2.5rem; 
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .controls { 
            text-align: center; 
            margin-top: 15px; 
        }
        .btn { 
            background: rgba(255,255,255,0.2); 
            border: 1px solid rgba(255,255,255,0.3); 
            color: white; 
            padding: 12px 24px; 
            margin: 5px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 1rem;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        .btn:hover { 
            background: rgba(255,255,255,0.3); 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        .status { 
            text-align: center; 
            margin: 20px; 
            padding: 15px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px; 
        }
        .stat-card { 
            background: rgba(255,255,255,0.1); 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .stat-card h3 { 
            font-size: 2rem; 
            margin-bottom: 5px; 
            color: #FFD700;
        }
        .plot-container { 
            margin: 20px; 
            padding: 20px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .plot-container h2 { 
            margin-bottom: 15px; 
            text-align: center;
            color: #FFD700;
        }
        .segments-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .segment-plot { 
            background: rgba(255,255,255,0.05); 
            border-radius: 10px; 
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .segment-plot h3 { 
            text-align: center; 
            margin-bottom: 10px;
            color: #FFD700;
        }
        #connectionStatus { 
            display: inline-block; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            margin-right: 8px; 
        }
        .connected { background-color: #4CAF50; }
        .disconnected { background-color: #f44336; }
        .log-container {
            margin: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #FFD700;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ§  Muse 2 EEG Real-Time Dashboard</h1>
        <div class="status">
            <span id="connectionStatus" class="disconnected"></span>
            <span id="statusText">Connecting...</span>
        </div>
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startStreaming()">Start Streaming</button>
            <button class="btn" id="stopBtn" onclick="stopStreaming()" disabled>Stop Streaming</button>
            <button class="btn" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat-card">
            <h3 id="fragmentCount">0</h3>
            <p>Fragments</p>
        </div>
        <div class="stat-card">
            <h3 id="segmentCount">0</h3>
            <p>Segments</p>
        </div>
        <div class="stat-card">
            <h3 id="bufferSize">0</h3>
            <p>Buffer Size</p>
        </div>
        <div class="stat-card">
            <h3 id="uptime">0</h3>
            <p>Uptime (s)</p>
        </div>
    </div>

    <div class="plot-container">
        <h2>ðŸ“ˆ Live Fragment (10s window)</h2>
        <div id="fragmentPlot"></div>
    </div>

    <div class="plot-container">
        <h2>ðŸ”¬ Real-Time Segments (2s windows)</h2>
        <div class="segments-grid" id="segmentsContainer"></div>
    </div>

    <div class="plot-container">
        <h2>ðŸ“‹ Activity Log</h2>
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        const socket = io();
        let fragmentPlotData = {};
        let segmentPlots = {};

        // Connection status
        socket.on('connect', function() {
            document.getElementById('connectionStatus').className = 'connected';
            document.getElementById('statusText').textContent = 'Connected to server';
            addLog('Connected to EEG streamer');
        });

        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').className = 'disconnected';
            document.getElementById('statusText').textContent = 'Disconnected from server';
            addLog('Disconnected from server');
        });

        // Stream control
        function startStreaming() {
            socket.emit('request_start_stream');
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        }

        function stopStreaming() {
            socket.emit('request_stop_stream');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        // Logging
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }

        // Socket event handlers
        socket.on('stream_status', function(data) {
            addLog(`Stream ${data.status}: ${data.message}`);
            document.getElementById('statusText').textContent = data.message;
        });

        socket.on('statistics', function(data) {
            document.getElementById('fragmentCount').textContent = data.fragment_count;
            document.getElementById('segmentCount').textContent = data.segment_count;
            document.getElementById('bufferSize').textContent = data.buffer_size;
            document.getElementById('uptime').textContent = Math.round(data.uptime);
        });

        socket.on('new_fragment', function(data) {
            addLog(`New fragment ${data.fragment_id} (${data.duration.toFixed(2)}s)`);
            updateFragmentPlot(data);
        });

        socket.on('new_segments', function(data) {
            addLog(`${data.segments.length} new segments from fragment ${data.fragment_id}`);
            updateSegmentPlots(data);
        });

        function updateFragmentPlot(fragmentData) {
            const traces = [];
            
            for (let ch = 0; ch < fragmentData.channel_names.length; ch++) {
                const channelData = fragmentData.data.map(sample => sample[ch]);
                
                traces.push({
                    x: fragmentData.time,
                    y: channelData,
                    type: 'scatter',
                    mode: 'lines',
                    name: fragmentData.channel_names[ch],
                    line: { width: 2 }
                });
            }

            const layout = {
                title: `Fragment ${fragmentData.fragment_id} - ${fragmentData.duration.toFixed(2)}s`,
                xaxis: { title: 'Time (s)' },
                yaxis: { title: 'Amplitude (Î¼V)' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.1)',
                font: { color: 'white' }
            };

            Plotly.newPlot('fragmentPlot', traces, layout);
        }

        function updateSegmentPlots(segmentData) {
            const container = document.getElementById('segmentsContainer');
            container.innerHTML = ''; // Clear existing plots

            segmentData.segments.forEach((segment, index) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'segment-plot';
                segmentDiv.innerHTML = `<h3>Segment ${segment.segment_id + 1}</h3><div id="segment_${index}"></div>`;
                container.appendChild(segmentDiv);

                const traces = [];
                
                for (let ch = 0; ch < segmentData.channel_names.length; ch++) {
                    const channelData = segment.data.map(sample => sample[ch]);
                    
                    traces.push({
                        x: segment.time,
                        y: channelData,
                        type: 'scatter',
                        mode: 'lines',
                        name: segmentData.channel_names[ch],
                        line: { width: 1.5 }
                    });
                }

                const layout = {
                    title: `${segment.duration.toFixed(2)}s (${segment.start_time.toFixed(1)}s - ${segment.end_time.toFixed(1)}s)`,
                    xaxis: { title: 'Time (s)' },
                    yaxis: { title: 'Î¼V' },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(255,255,255,0.1)',
                    font: { color: 'white' },
                    margin: { t: 40, b: 40, l: 50, r: 20 },
                    height: 300
                };

                Plotly.newPlot(`segment_${index}`, traces, layout);
            });
        }

        // Initial setup
        addLog('EEG Dashboard loaded - Ready to start streaming');
    </script>
</body>
</html>